<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Index automatique des documents – AHPV-documents</title>
  <style>
    :root { --bg:#0b1120; --card:#111827; --muted:#9ca3af; --fg:#e5e7eb; --accent:#60a5fa; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{padding:16px 20px;border-bottom:1px solid #1f2937;background:#0b1120;position:sticky;top:0;z-index:2}
    h1{margin:0 0 8px 0;font-size:20px}
    .wrap{max-width:1100px;margin:0 auto}
    .muted{color:#9ca3af;font-size:13px}
    main{max-width:1100px;margin:22px auto;padding:0 16px}
    .card{background:#111827;border:1px solid #1f2937;border-radius:16px;overflow:hidden}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #1f2937;flex-wrap:wrap}
    input,select{background:#0f172a;color:var(--fg);border:1px solid #1f2937;border-radius:10px;padding:10px 12px}
    input[type="text"]{width:220px}
    .badge{font-size:12px;background:#0f172a;border:1px solid #1f2937;color:#9ca3af;padding:4px 8px;border-radius:999px;text-decoration:none}
    .list{width:100%;border-collapse:collapse}
    .list th,.list td{padding:10px 12px;border-top:1px solid #1f2937;background:#111827}
    .list th{color:#9ca3af;background:#0f172a;text-align:left;position:sticky;top:64px}
    .path{color:#9ca3af;font-size:13px}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:#0f172a;border:1px solid #1f2937;color:#9ca3af}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Index automatique des documents</h1>
      <div class="muted" id="repoInfo">Dépôt : mich59139/AHPV-documents</div>
    </div>
  </header>

  <main>
    <div class="card">
      <div class="toolbar">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="search" type="text" placeholder="Rechercher…" />
          <select id="ext">
            <option value="">Toutes extensions</option>
            <option>pdf</option><option>docx</option><option>xlsx</option><option>pptx</option>
            <option>jpg</option><option>png</option><option>svg</option><option>txt</option><option>md</option>
          </select>
          <select id="sort">
            <option value="name">Tri : Nom (A→Z)</option>
            <option value="name_desc">Tri : Nom (Z→A)</option>
            <option value="size">Tri : Taille (↑)</option>
            <option value="size_desc">Tri : Taille (↓)</option>
          </select>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <span id="status" class="pill">Prêt</span>
          <a id="repoLink" class="badge" href="https://github.com/mich59139/AHPV-documents" target="_blank">Voir sur GitHub ↗</a>
        </div>
      </div>

      <table class="list">
        <thead><tr><th>Nom</th><th>Extension</th><th>Taille</th><th>Chemin</th><th>Accès</th></tr></thead>
        <tbody id="tbody"><tr><td colspan="5" class="path">Chargement…</td></tr></tbody>
      </table>
    </div>
  </main>

<script>
const OWNER = "mich59139";
const REPO  = "AHPV-documents";
let   BRANCH = "main";

const el=(id)=>document.getElementById(id);
const prettySize=(b)=>{ if(!b) return ''; const u=['B','KB','MB','GB']; let i=0,v=b; while(v>=1024&&i<u.length-1){v/=1024;i++;} return (v<10&&i>0?v.toFixed(1):Math.round(v))+' '+u[i]; };
const encodeP=(p)=>p.split('/').map(encodeURIComponent).join('/');
const escapeHtml=(s)=>s.replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\\'':'&#39;'}[c]));

async function init(){
  try{
    setStatus('Chargement…');
    const meta = await fetchJSON(`https://api.github.com/repos/${OWNER}/${REPO}`);
    BRANCH = meta.default_branch || 'main';
    const tree = await fetchJSON(`https://api.github.com/repos/${OWNER}/${REPO}/git/trees/${BRANCH}?recursive=1`);
    const blobs = (tree.tree||[]).filter(n=>n.type==='blob');
    const files = blobs.map(n=>{
      const path=n.path;
      const name=path.split('/').pop();
      const ext=name.includes('.')?name.split('.').pop().toLowerCase():'';
      return {path,name,ext,size:n.size||0};
    });

    el('search').addEventListener('input', ()=>render(files));
    el('ext').addEventListener('change',  ()=>render(files));
    el('sort').addEventListener('change', ()=>render(files));

    render(files);
    setStatus(`OK – ${files.length} fichiers`);
  }catch(e){
    console.error(e);
    setStatus('Erreur : dépôt privé ? (doit être public)');
  }
}

function render(files){
  const q=el('search').value.trim().toLowerCase();
  const ext=el('ext').value;
  const sort=el('sort').value;
  let rows = files.filter(f=>{
    const inQ=!q||f.name.toLowerCase().includes(q)||f.path.toLowerCase().includes(q);
    const inE=!ext||f.ext===ext;
    const isDocs=f.path.startsWith('docs/');
    return inQ&&inE&&!isDocs;
  });
  rows.sort((a,b)=>{
    if(sort==='name') return a.name.localeCompare(b.name);
    if(sort==='name_desc') return b.name.localeCompare(a.name);
    if(sort==='size') return (a.size||0)-(b.size||0);
    if(sort==='size_desc') return (b.size||0)-(a.size||0);
    return 0;
  });
  const tbody=el('tbody'); tbody.innerHTML='';
  const base=`https://mich59139.github.io/AHPV-documents`; // site projet
  for(const f of rows){
    const site=`${base}/${encodeP(f.path)}`;
    const gh  =`https://github.com/${OWNER}/${REPO}/blob/${BRANCH}/${encodeP(f.path)}`;
    const raw =`https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${encodeP(f.path)}`;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><a href="${site}" target="_blank">${escapeHtml(f.name)}</a></td>
                  <td>${escapeHtml(f.ext||'—')}</td>
                  <td>${prettySize(f.size)}</td>
                  <td class="path">${escapeHtml(f.path)}</td>
                  <td><a class="badge" href="${site}" target="_blank">Ouvrir</a>
                      <a class="badge" href="${gh}"  target="_blank">GitHub</a>
                      <a class="badge" href="${raw}" target="_blank">Raw</a></td>`;
    tbody.appendChild(tr);
  }
  if(rows.length===0){
    tbody.innerHTML='<tr><td colspan="5" class="path">Aucun fichier trouvé.</td></tr>';
  }
}

async function fetchJSON(url){
  const res=await fetch(url,{headers:{'Accept':'application/vnd.github+json'}});
  if(!res.ok) throw new Error('HTTP '+res.status);
  return res.json();
}
function setStatus(t){ el('status').textContent=t; }
init();
</script>
</body>
</html>
